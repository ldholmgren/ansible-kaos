---
- name: Disable faillock account lockout
  ansible.builtin.copy:
    content: |
      # Managed by Ansible - disable account lockout
      # deny=0 means never lock accounts
      deny=0
    dest: /etc/security/faillock.conf
    owner: root
    group: root
    mode: "0644"

- name: Reset any existing account locks
  ansible.builtin.command: faillock --user {{ username }} --reset
  changed_when: false
  failed_when: false

- name: Install security packages
  ansible.builtin.pacman:
    name:
      - bitwarden
      - bitwarden-cli
      - openssh
      - gnupg
      - pinentry
    state: present

- name: Ensure SSH directory exists
  ansible.builtin.file:
    path: "/home/{{ username }}/.ssh"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0700"

- name: Check if SSH key exists
  ansible.builtin.stat:
    path: "/home/{{ username }}/.ssh/id_ed25519"
  register: ssh_key_stat

- name: Generate SSH key if not present
  ansible.builtin.command:
    cmd: ssh-keygen -t ed25519 -f /home/{{ username }}/.ssh/id_ed25519 -N "" -C "{{ username }}@{{ ansible_hostname }}"
  become: true
  become_user: "{{ username }}"
  when: not ssh_key_stat.stat.exists
  changed_when: true

- name: Ensure systemd user directory exists
  ansible.builtin.file:
    path: "/home/{{ username }}/.config/systemd/user"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0755"

- name: Configure ssh-agent systemd user service
  ansible.builtin.template:
    src: ssh-agent.service.j2
    dest: "/home/{{ username }}/.config/systemd/user/ssh-agent.service"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0644"

- name: Enable ssh-agent user service
  ansible.builtin.systemd:
    name: ssh-agent
    enabled: true
    state: started
    scope: user
  become: true
  become_user: "{{ username }}"

- name: Ensure GPG directory exists
  ansible.builtin.file:
    path: "/home/{{ username }}/.gnupg"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0700"

- name: Configure GPG agent
  ansible.builtin.copy:
    content: |
      default-cache-ttl 3600
      max-cache-ttl 86400
      pinentry-program /usr/bin/pinentry-gnome3
      enable-ssh-support
    dest: "/home/{{ username }}/.gnupg/gpg-agent.conf"
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: "0600"
