---
- name: Install Niri compositor
  ansible.builtin.pacman:
    name:
      - niri
      - xwayland-satellite
    state: present

- name: Install ccache for AUR builds
  ansible.builtin.pacman:
    name: ccache
    state: present

- name: Install DankMaterialShell for Niri
  kewlfft.aur.aur:
    name: dms-shell-niri
    use: "{{ aur_helper }}"
    state: present
  become: true
  become_user: "{{ username }}"

- name: Install XDG portals
  ansible.builtin.pacman:
    name:
      - xdg-desktop-portal-gnome
      - xdg-desktop-portal-gtk
      - xdg-desktop-portal
    state: present

- name: Install Wayland utilities
  ansible.builtin.pacman:
    name: "{{ wayland_utils }}"
    state: present

- name: Install fonts
  ansible.builtin.pacman:
    name: "{{ font_packages }}"
    state: present

- name: Install AUR fonts
  kewlfft.aur.aur:
    name: "{{ aur_font_packages }}"
    use: "{{ aur_helper }}"
    state: present
  become: true
  become_user: "{{ username }}"
  when: aur_font_packages | length > 0

- name: Install Ghostty terminal
  ansible.builtin.pacman:
    name:
      - ghostty
      - ghostty-shell-integration
    state: present

- name: Install DankGreeter (greetd + DMS greeter)
  kewlfft.aur.aur:
    name: greetd-dms-greeter-git
    use: "{{ aur_helper }}"
    state: present
  become: true
  become_user: "{{ username }}"

- name: Ensure greetd config directory exists
  ansible.builtin.file:
    path: /etc/greetd
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Configure greetd for DankGreeter + Niri
  ansible.builtin.copy:
    content: |
      [terminal]
      vt = 1

      [default_session]
      user = "greeter"
      command = "dms-greeter --command niri -C /etc/greetd/niri.kdl"
    dest: /etc/greetd/config.toml
    owner: root
    group: root
    mode: "0644"

- name: Configure greeter niri session
  ansible.builtin.copy:
    content: |
      hotkey-overlay {
          skip-at-startup
      }

      environment {
          DMS_RUN_GREETER "1"
      }

      gestures {
          hot-corners {
              off
          }
      }

      layout {
          background-color "#000000"
      }
    dest: /etc/greetd/niri.kdl
    owner: root
    group: root
    mode: "0644"

- name: Disable conflicting display managers
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: false
  loop:
    - sddm
    - gdm
    - lightdm
  failed_when: false

- name: Enable greetd
  ansible.builtin.systemd:
    name: greetd
    enabled: true

- name: Update font cache
  ansible.builtin.command: fc-cache -fv
  changed_when: true
