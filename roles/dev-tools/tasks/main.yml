---
- name: Install development packages
  ansible.builtin.pacman:
    name: "{{ dev_packages }}"
    state: present

- name: Install container tools
  ansible.builtin.pacman:
    name:
      - podman
      - distrobox
      - buildah
      - skopeo
    state: present

- name: Enable podman socket for rootless containers
  ansible.builtin.systemd:
    name: podman.socket
    enabled: true
    scope: user
  become: true
  become_user: "{{ username }}"

- name: Check if Nix is installed
  ansible.builtin.stat:
    path: /nix
  register: nix_dir

- name: Install Nix (daemon mode)
  when: not nix_dir.stat.exists
  block:
    - name: Download Nix installer
      ansible.builtin.get_url:
        url: https://nixos.org/nix/install
        dest: /tmp/nix-install.sh
        mode: "0755"

    - name: Run Nix installer (daemon mode)
      ansible.builtin.command: /tmp/nix-install.sh --daemon --yes
      changed_when: true

    - name: Clean up Nix installer
      ansible.builtin.file:
        path: /tmp/nix-install.sh
        state: absent

- name: Configure Nix (enable flakes + nix-command)
  ansible.builtin.copy:
    content: |
      # Managed by Ansible
      experimental-features = nix-command flakes
      trusted-users = root {{ username }}
    dest: /etc/nix/nix.conf
    owner: root
    group: root
    mode: "0644"
  notify: Restart nix-daemon

- name: Enable nix-daemon service
  ansible.builtin.systemd:
    name: nix-daemon
    enabled: true
    state: started

- name: Install nix-direnv via nix
  ansible.builtin.command:
    cmd: nix profile install nixpkgs#nix-direnv
  become: true
  become_user: "{{ username }}"
  register: nix_direnv_install
  changed_when: "'installed' in nix_direnv_install.stdout | default('')"
  failed_when: false
  environment:
    PATH: "/nix/var/nix/profiles/default/bin:{{ ansible_env.PATH }}"

- name: Install Node.js (LTS)
  ansible.builtin.pacman:
    name:
      - nodejs-lts-jod
      - npm
    state: present
